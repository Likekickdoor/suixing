<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="shortcut Icon" href="favicon.ico">
    <link rel="stylesheet" type="text/css" href="html/detailsHtml/css/details.css">
    <link rel="stylesheet" type="text/css" href="html/detailsHtml/css/transCity.css">
    <link rel="stylesheet" type="text/css" href="html/detailsHtml/css/Plugins/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="html/detailsHtml/css/Plugins/daterangepicker.css">
    <title>换乘界面</title>
</head>
<body onselectstart="return false">
    <div class="header">
        <div class="headerContent">
            <div class="siteName">
                <a href="./index.php"><img src="favicon.ico" /><span>随行网</span></a>
            </div>
            <div class="siteContents">
                <li><a href="./index.php">首页</a></li>
                <li><a href="./index.php" class="active">查询</a></li>
                <li><a href="./index.php#about">关于</a></li>
                <li><a href="./index.php#advantage">优势</a></li>
                <li><a href="./index.php#feature">未来</a></li>
                <li><a href="./index.php#contact">联系我们</a></li>
            </div>
        </div>
    </div>
    <div class="theBackBoard">
        <!-- <img src="img/screen.jpg" /> -->
    </div>
    <div class="searchArea">
        <form action="index.php" method="GET" id="mainForm">
        <div class="InputWhere">
            <div class="start">
                <input type="text" id="start" name="dpplace" placeholder="输入起点" autocomplete="off" spellcheck="false"/>
                <!-- 此处为下拉城市名列表 -->
                <ul class="listCityName">
                    
                </ul>
            </div>
            <div class="SEbutton">
                <input type="button" id="SEbutton" /></div>
            <div class="end">
                <input type="text" id="end" name="arrplace" placeholder="输入终点" autocomplete="off" spellcheck="false"/>
                <ul class="listCityName">
                    
                </ul>
            </div>
        </div>
        <div class="InputWhen">
            <input type="text" name="dateRange" placeholder="选择日期">
        </div>
        <div class="addScreen"><a>添加筛选</a></div>
        <div class="screenMenu">
            <div class="grayLine">
                <div>是否直达</div>
                <div><input name="SFZD" type="checkbox"/></div>
            </div>
            <div class="grayLine">
                <div>交通工具</div>
                <div>
                    <li><div>火车</div><div><input name="trainCheck" type="checkbox"/></div></li>
                    <li><div>汽车</div><div><input name="busCheck" type="checkbox"/></div></li>
                    <li><div>飞机</div><div><input name="planeCheck" type="checkbox"/></div></li>
                </div>
            </div>
            <div class="btnScreen"><a>关闭</a></div>
        </div>
        <div class="InputSubmit">
            <input type="button" id="submit" value="查&nbsp;询" />
        </div>
        <div class="wait" style="display: none">请稍后</div>
    </form>
    </div>
    <div class="zCard">
        <section class="zTitle">
            <section class="zLeft">
                <div></div>
                <div>CityA</div>
                <div>至</div>
                <div>CityB</div>
                <section class="title">需换乘</section>
            </section>
        </section>
        <ul class="ulTRANSCITIES">
            <li class="Normal zTRAIN zBUS zSHIP">
                <div class="zMoreInfo">
                    <div class="zCostTime">
                        <span class="zTime">5时20分</span>
                    </div>
                    <div class="zPrices">
                        <span class="currencySymbol">￥</span>
                        <span class="prices">200</span>
                    </div>
                </div>
                <section class="ranking"><span>01</span></section>
                <section class="split">
                    <div class="info">
                        <div><span></span></div>
                        <div><span></span></div>
                        <div><span></span></div>
                        <div><span></span></div>
                        <div><span></span></div>
                        <p><span>长沙市</span><span class="has">武汉市</span></p>
                    </div>
                    <div class="expandSection"></div>
                </section>
                <section class="splits">
                    <p><span style="color: #12a81e">洪江</span><span class="circleSpanTRAIN">0</span><span>长沙市</span></p>
                    <div class="expandSection">
                    </div>
                </section>
                <section class="splits">
                    <p><span>长沙市</span><span class="circleSpanSHIP">0</span><span>武汉市</span></p>
                    <div class="expandSection">
                    </div>
                </section>
                <section class="splits">
                    <p><span>武汉市</span><span class="circleSpanBUS">0</span><span style="color: #2186fa">桃源</span></p>
                    <div class="expandSection">
                    </div>
                </section>
            </li>
        </ul>
    </div>
</body>
<script src="html/detailsHtml/js/jquery-3.3.1.js"></script>
<script src="html/detailsHtml/js/Plugins/moment.js"></script>
<script src="html/detailsHtml/js/Plugins/daterangepicker.js"></script>
<!-- <script src="html/detailsHtml/js/details.js"></script> -->
<script>
    $(document).ready(function(){
        function GETplace(){
            //以下添加自动填写表单内容
            var urlStr = decodeURIComponent(window.location.search);
            var arrStr = urlStr.split('=');
            var URLdpplace = arrStr[3].replace(/[^\u4e00-\u9fa5]/gi, "");
            var URLarrplace = arrStr[4];
            return URLdpplace + ',' + URLarrplace;
        };
        GETplace();
        var strSandEplace = GETplace();
        // alert(strSandEplace);
        arrSandEplace = strSandEplace.split(',');
        var startPlace = arrSandEplace[0];
        var endPlace = arrSandEplace[1];
        $('#start').val(startPlace);
        $('#end').val(endPlace);
        $('.zLeft').children('div').eq(1).html(startPlace);
        $('.zLeft').children('div').eq(3).html(endPlace);
        // alert(startPlace);
        // alert(endPlace);
        function GETJSONLENGTH(jsonData){
            var JSONLENGTH = 0;
            for(var item in jsonData){
                JSONLENGTH ++;
            }
            return JSONLENGTH;
        };
        $.ajax({
            url: './index.php?con=details&med=interchange&start=' + startPlace + '&end=' + endPlace,
            type: 'GET',
            dataType: 'json',
            beforeSend: function(){
                $('.wait').css({"display": "block"});
            },
            complete: function(){
                $('.wait').css({"display": "none"});
            },
            success: function(data){
                console.log(data);
                var tagFeature = "";
                var Price = "";
                var costTime = "";
                function add_about(){
                    if(data[i].first.arrive_time && firstBUSwholeMINIUTE == 0){
                        return '约';
                    }
                    if(data[i].second.arrive_time && secondBUSwholeMINIUTE == 0){
                        return '约';
                    }
                }
                function foolerTagFeature(){
                    if(data[i].first.arrive_time && data[i].second.arrive_time){
                        tagFeature = 'ZBUS zBUS';
                    }
                    if(data[i].first.arrive_time && data[i].second.Adistance){
                        tagFeature = 'ZBUS zTRAIN'
                    }
                    if(data[i].first.arrive_time && data[i].second.valuation){
                        tagFeature = 'ZBUS zPLANE'
                    }


                    if(data[i].first.Adistance && data[i].second.Adistance){
                        tagFeature = 'zTRAIN zTRAIN'
                    }
                    if(data[i].first.Adistance && data[i].second.arrive_time){
                        tagFeature = 'zTRAIN zBUS'
                    }
                    if(data[i].first.Adistance && data[i].second.valuation){
                        tagFeature = 'zTRAIN zPLANE'
                    }


                    if(data[i].first.valuation && data[i].second.valuation){
                        tagFeature = 'zPLANE zPLANE'
                    }
                    if(data[i].first.valuation && data[i].second.arrive_time){
                        tagFeature = 'zPLANE zBUS'
                    }
                    if(data[i].first.valuation && data[i].second.Adistance){
                        tagFeature = 'zPLANE zTRAIN'
                    }
                    return tagFeature;
                };
                function foolerPrice(){
                    if(data[i].first.arrive_time && data[i].second.arrive_time){
                        Price = parseInt(data[i].first.price) + parseInt(data[i].second.price);
                    }
                    if(data[i].first.arrive_time && data[i].second.Adistance){
                        var train_prices = 0;
                        if(data[i].second.hardSeat){
                            train_prices = parseInt(data[i].second.hardSeat);
                        }else if(data[i].second.bSeat){
                            train_prices = parseInt(data[i].second.bSeat);
                        }
                        Price = train_prices + parseInt(data[i].first.price)
                    }
                    if(data[i].first.arrive_time && data[i].second.valuation){
                        Price = parseInt(data[i].first.price) + parseInt(data[i].second.valuation)
                    }

                    var firstTrainPrice = 0;
                    if(data[i].first.bSeat){
                        firstTrainPrice = parseInt(data[i].first.bSeat);
                    }else if(data[i].first.hardSeat){
                        firstTrainPrice = parseInt(data[i].first.hardSeat);
                    }
                    if(data[i].first.Adistance && data[i].second.Adistance){
                        var train_prices = 0;
                        if(data[i].second.hardSeat){
                            train_prices = parseInt(data[i].second.hardSeat);
                        }else if(data[i].second.bSeat){
                            train_prices = parseInt(data[i].second.bSeat);
                        }
                        Price = firstTrainPrice + train_prices
                    }
                    if(data[i].first.Adistance && data[i].second.arrive_time){
                        Price = firstTrainPrice + parseInt(data[i].second.price)
                    }
                    if(data[i].first.Adistance && data[i].second.valuation){
                        Price = firstTrainPrice + parseInt(data[i].second.valuation)
                    }


                    if(data[i].first.valuation && data[i].second.valuation){
                        Price = parseInt(data[i].first.valuation) + parseInt(data[i].second.valuation)
                    }
                    if(data[i].first.valuation && data[i].second.arrive_time){
                        Price = parseInt(data[i].first.valuation) + parseInt(data[i].second.price)
                    }
                    if(data[i].first.valuation && data[i].second.Adistance){
                        var train_prices = 0;
                        if(data[i].second.hardSeat){
                            train_prices = parseInt(data[i].second.hardSeat);
                        }else if(data[i].second.bSeat){
                            train_prices = parseInt(data[i].second.bSeat);
                        }
                        Price = parseInt(data[i].first.valuation) + train_prices
                    }
                    return Price;

                };
                function foolerCostTime(){
                    firstBUSwholeMINIUTE = 0;
                    secondBUSwholeMINIUTE = 0;
                    firstTRAINwholeMINIUTE = 0;
                    secondTRAINwholeMINIUTE = 0;
                    firstPLANEwholeMINIUTE = 0;
                    secondPLANEwholeMINIUTE = 0;
                    if(data[i].first.arrive_time){
                        firstBUSwholeMINIUTE = parseInt(data[i].first.time.split('时')[0])*60 + parseInt(data[i].first.time.split('时')[1]);                        
                    }
                    if(data[i].second.arrive_time){
                        secondBUSwholeMINIUTE = parseInt(data[i].second.time.split('时')[0])*60 + parseInt(data[i].second.time.split('时')[1]);                        
                    }
                    if(data[i].first.Adistance){
                        firstTRAINwholeMINIUTE = data[i].first.BrunTime - data[i].first.ArunTime;
                    }
                    if(data[i].second.Adistance){
                        secondTRAINwholeMINIUTE = data[i].second.BrunTime - data[i].second.ArunTime;
                    }
                    if(data[i].first.valuation){
                        firstPLANEwholeMINIUTE = parseInt(data[i].first.f_flightTime.split('时')[0])*60 + parseInt(data[i].first.f_flightTime.split('时')[1]);                        
                    }
                    if(data[i].second.valuation){
                        secondPLANEwholeMINIUTE = parseInt(data[i].second.f_flightTime.split('时')[0])*60 + parseInt(data[i].second.f_flightTime.split('时')[1]);                        
                    }
                    if(data[i].first.arrive_time && data[i].second.arrive_time){
                        // var secondBusTimeHOUR = parseInt(data[i].second.time.split('时')[0]);
                        costTime = add_about() + Math.floor((firstBUSwholeMINIUTE + secondBUSwholeMINIUTE)/60) + '时' + (firstBUSwholeMINIUTE + secondBUSwholeMINIUTE)%60 + '分';
                        // var secondBusTimeMINT = parseInt(data[i].second.time.split('时')[1]);
                    }
                    if(data[i].first.arrive_time && data[i].second.Adistance){
                        costTime = add_about() + Math.floor((firstBUSwholeMINIUTE + secondTRAINwholeMINIUTE)/60) + '时' + (firstBUSwholeMINIUTE + secondTRAINwholeMINIUTE)%60 + '分';
                    }
                    if(data[i].first.arrive_time && data[i].second.valuation){
                        costTime = add_about() + Math.floor((firstBUSwholeMINIUTE + secondPLANEwholeMINIUTE)/60) + '时' + (firstBUSwholeMINIUTE + secondPLANEwholeMINIUTE)%60 + '分';
                    }


                    if(data[i].first.Adistance && data[i].second.Adistance){
                        costTime = Math.floor((firstTRAINwholeMINIUTE + secondTRAINwholeMINIUTE)/60) + '时' + (firstTRAINwholeMINIUTE + secondTRAINwholeMINIUTE)%60 + '分';
                    }
                    if(data[i].first.Adistance && data[i].second.arrive_time){
                        costTime = add_about() + Math.floor((firstTRAINwholeMINIUTE + secondBUSwholeMINIUTE)/60) + '时' + (firstTRAINwholeMINIUTE + secondBUSwholeMINIUTE)%60 + '分';
                    }
                    if(data[i].first.Adistance && data[i].second.valuation){
                        costTime = Math.floor((firstTRAINwholeMINIUTE + secondPLANEwholeMINIUTE)/60) + '时' + (firstTRAINwholeMINIUTE + secondPLANEwholeMINIUTE)%60 + '分';                        
                    }


                    if(data[i].first.valuation && data[i].second.valuation){
                        costTime = Math.floor((firstPLANEwholeMINIUTE + secondPLANEwholeMINIUTE)/60) + '时' + (firstPLANEwholeMINIUTE + secondPLANEwholeMINIUTE)%60 + '分';                        
                    }
                    if(data[i].first.valuation && data[i].second.arrive_time){
                        costTime = add_about() + Math.floor((firstPLANEwholeMINIUTE + secondBUSwholeMINIUTE)/60) + '时' + (firstPLANEwholeMINIUTE + secondBUSwholeMINIUTE)%60 + '分';                        
                    }
                    if(data[i].first.valuation && data[i].second.Adistance){
                        costTime = Math.floor((firstPLANEwholeMINIUTE + secondTRAINwholeMINIUTE)/60) + '时' + (firstPLANEwholeMINIUTE + secondTRAINwholeMINIUTE)%60 + '分';                        
                    }
                    return costTime;
                };
                function foolerDisplayTansCity(){
                    var firstTansCityNAME = "";
                    var secondTansCityNAME = "";
                    var NAMEHtml = '';
                    function addNAMEHtml(){
                        if(TransportNum == 2){
                            NAMEHtml = '<span>' + firstTansCityNAME + '</span>'
                        }
                        if(TransportNum == 3){
                            NAMEHtml = '<span>' + firstTansCityNAME + '</span>' + '<span class="has">' + '</span>'
                        }
                    };
                    if(data[i].first.arrive_time){
                        firstTansCityNAME = data[i].first.end_station_name;
                        addNAMEHtml()
                    }
                    if(data[i].first.Adistance){
                        firstTansCityNAME = data[i].first.arrSta;
                        addNAMEHtml()
                    }
                    if(data[i].first.valuation){
                        firstTansCityNAME = data[i].first.f_toAirport;
                        addNAMEHtml()
                    }
                    return NAMEHtml;
                };
                function foolerCycleSplits(){
                    var cycleHTMLs = "";
                    for(var f=0; f<TransportNum; f++){
                        var StartNameColor = '';
                        var EndNameColor = '';
                        var firstSpanName = '';
                        var lastSpanName = '';
                        var centerSpanClass = '';
                        if(f==0){
                            StartNameColor = '#12a81e';
                            if(data[i].first.Adistance){
                                centerSpanClass = 'circleSpanTRAIN';
                                firstSpanName = data[i].first.dpSta;
                                lastSpanName = data[i].first.arrSta;
                            }
                            if(data[i].first.arrive_time){
                                centerSpanClass = 'circleSpanBUS';
                                firstSpanName = data[i].first.start_station_name;
                                lastSpanName = data[i].first.end_station_name;
                            }
                            if(data[i].first.valuation){
                                centerSpanClass = 'circleSpanPLANE';
                                firstSpanName = data[i].first.f_fromAirport;
                                lastSpanName = data[i].first.f_toAirport;
                            }
                        }else if(f==1){
                            if(data[i].second.Adistance){
                                centerSpanClass = 'circleSpanTRAIN';
                                firstSpanName = data[i].second.dpSta;
                                lastSpanName = data[i].second.arrSta;
                            }
                            if(data[i].second.arrive_time){
                                centerSpanClass = 'circleSpanBUS';
                                firstSpanName = data[i].second.start_station_name;
                                lastSpanName = data[i].second.end_station_name;
                            }
                            if(data[i].second.valuation){
                                centerSpanClass = 'circleSpanPLANE';
                                firstSpanName = data[i].second.f_fromAirport;
                                lastSpanName = data[i].second.f_toAirport;
                            }
                        }
                        if(f==TransportNum-1){
                            EndNameColor = '#2186fa';
                        }else if(f!=0){
                            StartNameColor = 'black';
                            EndNameColor = 'black';
                        };
                        var cycleHTML = 
                        `
                        <section class="splits">
                            <p><span style="color: ${StartNameColor}">${firstSpanName}</span><span class="${centerSpanClass}">0</span><span style="color: ${EndNameColor}">${lastSpanName}</span></p>
                            <div class="expandSection">
                                <div></div>
                            </div>
                        </section>
                        `
                        cycleHTMLs += cycleHTML;
                    }
                    return cycleHTMLs;
                }
                // console.log(data.length)
                var HTMLs = "";
                // json = eval(data);
                for(var i=0; i<data.length; i++){
                    var TransportNum = GETJSONLENGTH(data[i]);
                    console.log('数组的第' + i + '条' + '有' + TransportNum + '条路线');
                    function returnZero(i){
                        if(i<9){
                            i = i+1;
                            return "0" + i;
                        }else if(i>=9){
                            i = i+1;
                            return i;
                        }
                    }
                    // alert(fooler(Price));
                    // alert(fooler(costTime));
                    var HTML = 
                    `
                    <li class="Normal ${foolerTagFeature()}">
                        <div class="zMoreInfo">
                            <div class="zCostTime">
                                <span class="zTime">${foolerCostTime()}</span>
                            </div>
                            <div class="zPrices">
                                <span class="currencySymbol">￥</span>
                                <span class="prices">${foolerPrice()}</span>
                            </div>
                        </div>
                        <section class="ranking"><span>${returnZero(i)}</span></section>
                        <section class="split">
                            <div class="info">
                                <div><span></span></div>
                                <div><span></span></div>
                                <div><span></span></div>
                                <div><span></span></div>
                                <div><span></span></div>
                                <p>${foolerDisplayTansCity()}</p>
                            </div>
                            <div class="expandSection"></div>
                        </section>
                        ${foolerCycleSplits()}
                    </li>
                    `
                    HTMLs += HTML;
                }
                $('.ulTRANSCITIES').html(HTMLs);
                // alert('success');
                showHidep();

            },
            error: function(){
                alert('failed');
            }
        });
        function showHidep(){
            $('li .zMoreInfo').each(function(){
                $(this).parent().children('.split').children('.info').children('div').eq(4).children('span').click(function(){
                    $(this).parent().stop().fadeOut('fast');
                    $(this).parent().parent().parent().parent().find('p').removeClass('selected');
                    // alert($(this).parent().parent().parent().parent().find('p').attr('class'));
                });
            });
            $('.splits').click(function(){
                // $(this).children('p').removeClass('selected');
                $(this).children('.expandSection').stop().slideToggle(400);
                var splitColor = $(this).children('p').children('span').eq(1).css('backgroundColor').split(', ');
                splitBGColor = splitColor[0].split('(')[0].replace('rgb', 'rgba') + '(' + splitColor[0].split('(')[1] + ', ' + splitColor[1] + ', ' + splitColor[2].replace(')',', .8)')
                $(this).children('.expandSection').css({"backgroundColor": splitBGColor});
            });
            $('.splits p').click(function(){
                var oExSLength = $(this).parent().parent().find('.expandSection').length -1;
                $(this).toggleClass('selected');
                var selectedLength = $(this).parent().parent().find('.selected').length;
                if(selectedLength == 0){
                    $(this).parent().parent().children('.split').children('.info').children('div').eq(4).stop().fadeOut(400);
                }else{
                    $(this).parent().parent().children('.split').children('.info').children('div').eq(4).stop().fadeIn(400);
                }
            });
            $('.expandSection').each(function(){
                $(this).click(function(){
                    $(this).parent().children('p').toggleClass('selected');
                    var selectedLength = $(this).parent().parent().find('.selected').length;
                    if(selectedLength == 0){
                        $(this).parent().parent().children('.split').children('.info').children('div').eq(4).stop().fadeOut(400);
                    }else{
                        $(this).parent().parent().children('.split').children('.info').children('div').eq(4).stop().fadeIn(400);
                    }
                });
            });
            $('.ulTRANSCITIES li .split .info').each(function(){
                $(this).click(function(){
                    $(this).parent().parent().children('.splits').find('.expandSection').slideUp(400);
                });
            });
        };
    });
    // alert(GETplace());
    $('#submit').click(function(){
        var zStartPlace = $('#start').val().replace(/\ +/g, "").replace(/[1-9]+/g, "");
        var zEndPlace = $('#end').val().replace(/\ +/g, "").replace(/[1-9]+/g, "");
        // alert(zStartPlace);
        // alert(zEndPlace);
        if(zStartPlace.length != 0 && zEndPlace.length != 0 && zStartPlace != zEndPlace){
            window.location.href = './index.php?con=details&med=display&start=' + zStartPlace + '&end=' + zEndPlace;
        }else if(zStartPlace != 0 && zEndPlace == 0){
            $('#end').focus();
            $('#end').css({"outlineColor": "#e81123"});
            $('#end').css({"backgroundColor": "#fff0f0"});
        }else if(zStartPlace == 0 && zEndPlace != 0){
            $('#start').focus();
            $('#start').css({"outlineColor": "#e81123"});
            $('#start').css({"backgroundColor": "#fff0f0"});
        }else{
            $('#end').focus();
            $('#end').css({"outlineColor": "#e81123"});
            $('#end').css({"backgroundColor": "#fff0f0"});
            $('#start').focus();
            $('#start').css({"outlineColor": "#e81123"});
            $('#start').css({"backgroundColor": "#fff0f0"});
            if(zStartPlace == zEndPlace && zStartPlace != 0 && zEndPlace != 0){
                $(this).parent().addClass('error');
            }
        }
    });
    $('#start, #end').on('input', function(){
        // console.log($(this).css('outlineColor'));
        $(this).css({"outlineColor": "#57acf6"});
        $(this).css({"backgroundColor": "rgba(255, 255, 255, .8)"});
        $(document).keydown(function(e){
            var key = e.keyCode;
            if(key == 13){
                jQuery("#submit").click();
            }
        });
    });
</script>
</html>